---
import { format } from "date-fns";
import type { Post } from "../../lib/types";
import {
  type Locale,
  defaultLocale,
  useTranslations,
  getLocalePath,
} from "../../i18n/config";

interface Props {
  post: Post;
}

const { post } = Astro.props;
const locale = (Astro.currentLocale ?? defaultLocale) as Locale;
const t = useTranslations(locale);
const formattedDate = format(new Date(post.date), t["date.format"]);
const href =
  post.type === "local" && post.slug
    ? getLocalePath(`/blog/${post.slug}`, locale)
    : post.url;
const isExternal = post.type !== "local";
const showJapaneseOnly = locale === "en" && post.source !== "local";
---

<a
  href={href}
  target={isExternal ? "_blank" : undefined}
  rel={isExternal ? "noopener noreferrer" : undefined}
  class="block h-full"
>
  <div class="bg-card text-card-foreground flex h-full flex-col gap-6 rounded-xl border py-6 shadow-sm overflow-hidden transition-colors hover:bg-accent/50">
    {post.ogImage && (
      <div class="relative aspect-40/21 px-0 -mt-6">
        <img
          src={post.ogImage}
          alt=""
          class="h-full w-full object-cover"
          loading="lazy"
        />
      </div>
    )}
    <div class="grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6">
      <div class="flex items-center gap-2">
        <time class="text-sm text-muted-foreground">{formattedDate}</time>
        {post.source === "local" && (
          <span class="inline-flex items-center justify-center rounded-full bg-primary text-primary-foreground px-2 py-0.5 text-xs font-medium">
            Local
          </span>
        )}
        {post.source === "zenn" && (
          <span class="inline-flex items-center justify-center rounded-full bg-secondary text-blue-600 dark:text-blue-400 px-2 py-0.5 text-xs font-medium">
            Zenn
          </span>
        )}
        {post.source === "bengo4" && (
          <span class="inline-flex items-center justify-center rounded-full bg-secondary text-green-600 dark:text-green-400 px-2 py-0.5 text-xs font-medium">
            Bengo4
          </span>
        )}
        {showJapaneseOnly && (
          <span class="inline-flex items-center justify-center rounded-full bg-orange-500/15 text-orange-700 dark:text-orange-300 border border-orange-500/20 px-2 py-0.5 text-xs font-medium">
            {t["blog.japaneseOnly"]}
          </span>
        )}
      </div>
      <div class="leading-snug font-semibold text-lg">
        <span class="inline">
          {post.title}
          {isExternal && (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1 inline-block size-4 align-text-bottom text-muted-foreground"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
          )}
        </span>
      </div>
    </div>
    <div class="mt-auto px-6">
      <div class="text-muted-foreground text-sm line-clamp-2">
        {post.description}
      </div>
      {post.tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-1.5">
          {post.tags.map((tag) => (
            <span class="inline-flex items-center justify-center rounded-full border border-border text-foreground px-2 py-0.5 text-xs font-medium">
              {tag}
            </span>
          ))}
        </div>
      )}
    </div>
  </div>
</a>
